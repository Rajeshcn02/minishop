name: CI + SAST + Deploy

on:
  push:
    branches: [ master ]
  pull_request:
  workflow_dispatch:
    inputs:
      deploy_env:
        description: "Where to deploy? (none/staging/production)"
        required: true
        default: "none"
        type: choice
        options:
          - none
          - staging
          - production

# Least-privilege permissions; jobs can override if needed
permissions:
  contents: read

concurrency:
  group: minishop-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    name: Build & Test (Maven)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Build + Unit Tests
        run: mvn -B clean test package

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: minishop-jar
          path: target/*.jar


  codeql-sast:
    name: SAST (CodeQL / GHAS)
    runs-on: ubuntu-latest
    needs: build-test

    # CodeQL needs these permissions
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java-kotlin
          # stronger than default; you can switch to "default"
          query-suite: security-extended

      # For Java, CodeQL needs a build to create the DB
      - name: Build for CodeQL
        run: mvn -B clean package -DskipTests

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

    # Notes:
    # - Requires GH Advanced Security / Code Scanning enabled for the repo. :contentReference[oaicite:1]{index=1}


  # docker-build:
  #   name: Docker Build (+ optional push)
  #   runs-on: ubuntu-latest
  #   needs: [build-test, codeql-sast]

  #   permissions:
  #     contents: read
  #     packages: write   # only used if pushing to GHCR

  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Download JAR artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: minishop-jar
  #         path: target

  #     - name: Docker build
  #       run: docker build -t ghcr.io/${{ github.repository_owner }}/minishop:${{ github.sha }} .

  #     # Optional push to GHCR only on master pushes
  #     - name: Login to GHCR
  #       if: github.event_name == 'push'
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Push image to GHCR
  #       if: github.event_name == 'push'
  #       run: docker push ghcr.io/${{ github.repository_owner }}/minishop:${{ github.sha }}


  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: codeql-sast

    # This is what triggers manual approval if staging env has required reviewers
    environment:
      name: staging

    if: github.event_name == 'workflow_dispatch' && inputs.deploy_env != 'none'

    steps:
      - name: Dummy deploy to Staging
        run: |
          echo "Deploying to STAGING..."
          echo "Image: ghcr.io/${{ github.repository_owner }}/minishop:${{ github.sha }}"
          echo "✅ Staging deployment completed (dummy)."


  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging

    environment:
      name: production

    if: github.event_name == 'workflow_dispatch' && inputs.deploy_env == 'production'

    steps:
      - name: Dummy deploy to Production
        run: |
          echo "Deploying to PRODUCTION..."
          echo "Image: ghcr.io/${{ github.repository_owner }}/minishop:${{ github.sha }}"
          echo "✅ Production deployment completed (dummy)."
